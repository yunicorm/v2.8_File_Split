# Path of Exile マクロ - スキルシステム刷新計画 v2.9.4

## 概要

本ドキュメントは、Path of Exile自動化マクロ（Wine of the Prophetビルド向け）のフラスコ・スキルシステムを全面的に刷新する計画を記述したものです。v2.9.3で実施した大規模モジュール分割を基盤として、より高度な自動化を実現します。

## 1. 現状の課題と改善目標

### 現状の課題
1. **スキルタブの扱いが不正確**: 左右中央クリックがスキルタブの一部として扱われているが、実際のゲームでは独立している
2. **スキル属性の未分類**: すべてのスキルが同じタイマーベースのループで処理されている
3. **視覚的フィードバックの未活用**: クールダウンのグレーレイヤーなど、ゲーム内の視覚情報を使用していない
4. **柔軟性の欠如**: スキルの挙動に応じた最適化ができない

### 改善目標
1. スキルスロットの正確なモデリング
2. スキル属性に基づく最適化されたループ処理
3. 視覚的フィードバックを活用した精密な制御
4. 設定UIの改善による使いやすさの向上

## 2. スキルスロットシステムの再設計

### 2.1 スキルスロットの正確な定義

#### 独立スロット（タブ切り替えの影響を受けない）
- **左クリック** (LButton)
- **右クリック** (RButton)
- **中央クリック** (MButton)

#### タブ依存スロット（タブ切り替えで変化）
| 1枚目タブ | 2枚目タブ | 説明 |
|-----------|-----------|------|
| Q | W | 第1スロット |
| L | K | 第2スロット |
| E | O | 第3スロット |
| R | N | 第4スロット |
| T | B | 第5スロット |

### 2.2 実装方針
```autohotkey
; 新しいスキルスロット管理システム
class SkillSlotManager {
    static independent_slots := ["LButton", "RButton", "MButton"]
    static tab_slots := Map(
        1, ["Q", "L", "E", "R", "T"],
        2, ["W", "K", "O", "N", "B"]
    )
    
    static GetActiveSlot(logical_slot, current_tab) {
        ; ロジカルスロットから実際のキーを返す
    }
}
```

## 3. スキル属性システム

### 3.1 属性の定義

#### A. インスタントスキル（即時開始クールダウン）
- **特徴**:
  - キー入力と同時にスキル発動＆クールダウン開始
  - グレーレイヤーが時計回りに消えていく
  - 他のスキルの使用を妨げない
  - 例: "Order! To me!" (Tキー)

- **視覚的検出**:
  - クールダウン中: グレーの半透明レイヤー
  - 使用可能: レイヤーなし
  - 進行状況: レイヤーの時計回り減少

#### B. ガードスキル（効果終了後クールダウン）
- **特徴**:
  - バフ持続中はクールダウンが開始されない
  - バフ終了と同時にクールダウン開始
  - 例: Molten Shell (Rキー)

- **視覚的検出**:
  - バフアイコン: 画面上部、黄緑の縁
  - バフ中: スキルアイコンは完全グレー
  - バフ終了後: クールダウンカウントダウン開始

### 3.2 将来の拡張用属性（予約）
#### C. チャネリングスキル
#### D. トグルスキル
#### E. リザーブスキル

## 4. 視覚的検出システムの統合

### 4.1 検出対象
1. **スキルアイコンのクールダウン状態**
   - グレーレイヤーの有無と進行度
   - 座標: Config.iniで設定可能

2. **バフアイコン**
   - 画面上部のバフバー
   - 持続時間の数値（OCR）

### 4.2 実装アプローチ
```autohotkey
; 視覚的検出を統合したスキルループ
class VisualSkillLoop {
    static CheckCooldown(skill_slot) {
        ; FindTextを使用してグレーレイヤーを検出
        ; 戻り値: true (使用可能) / false (クールダウン中)
    }
    
    static GetBuffDuration(buff_name) {
        ; OCRでバフの残り時間を読み取り
        ; 戻り値: 秒数 または -1 (バフなし)
    }
}
```

## 5. 設定UI改善計画

### 5.1 新しいタブ構造
1. **マウススキルタブ** (新規)
   - 左クリック設定
   - 右クリック設定
   - 中央クリック設定

2. **キーボードスキルタブ** (改修)
   - タブ1のスキル (Q, L, E, R, T)
   - タブ2のスキル (W, K, O, N, B)
   - タブ切り替え考慮の設定

3. **スキル属性タブ** (新規)
   - 各スキルの属性設定
   - 視覚的検出の有効/無効
   - カスタム検出パラメータ

### 5.2 設定項目の拡張
```ini
[SkillAttributes]
Skill_T_Type=Instant
Skill_T_VisualDetection=true
Skill_T_CooldownDuration=8000

Skill_R_Type=Guard
Skill_R_BuffName=molten_shell
Skill_R_BuffTracking=true
```

## 6. 実装ロードマップ

### Phase 1: 基盤整備（1-2週間）
1. **SkillSlotManager実装**
   - タブ管理ロジック
   - キーマッピング処理
   
2. **視覚的検出基盤**
   - FindText統合
   - 座標管理システム

### Phase 2: 属性システム実装（2-3週間）
1. **インスタントスキル実装**
   - クールダウン検出
   - 最適化されたループ
   
2. **ガードスキル実装**
   - バフ追跡
   - 状態遷移管理

### Phase 3: UI改善（1-2週間）
1. **設定ウィンドウ改修**
   - 新タブ追加
   - 属性設定UI
   
2. **視覚的フィードバック**
   - リアルタイムステータス表示
   - デバッグオーバーレイ

### Phase 4: 統合とテスト（1週間）
1. **既存システムとの統合**
2. **パフォーマンス最適化**
3. **エラーハンドリング強化**

## 7. Claude Codeへの実装指示

### 7.1 優先実装項目
1. **SkillSlotManager.ahk** の新規作成
2. **Features/Skills/SkillController.ahk** の改修
3. **UI/SettingsWindow/SkillTab.ahk** の拡張

### 7.2 段階的実装アプローチ
```markdown
## Step 1: スキルスロット管理の基盤実装
- ファイル: Features/Skills/SkillSlotManager.ahk (新規)
- 機能: タブ切り替えに対応したキーマッピング
- 依存: なし

## Step 2: 視覚的検出の統合
- ファイル: Features/Skills/VisualSkillDetection.ahk (新規)
- 機能: クールダウンとバフの視覚的検出
- 依存: Utils/FindText.ahk (要追加)

## Step 3: 属性ベースループの実装
- ファイル: Features/Skills/AttributeBasedLoop.ahk (新規)
- 機能: スキル属性に応じた最適化されたループ処理
- 依存: SkillSlotManager, VisualSkillDetection

## Step 4: 設定UIの改修
- ファイル: UI/SettingsWindow/MouseSkillTab.ahk (新規)
- 機能: マウススキル専用の設定タブ
- ファイル: UI/SettingsWindow/SkillAttributeTab.ahk (新規)
- 機能: スキル属性設定タブ
```

### 7.3 テストケース
1. **タブ切り替えテスト**: スキルタブを切り替えても正しいキーが送信されるか
2. **視覚的検出テスト**: クールダウンの検出精度
3. **属性別処理テスト**: インスタント/ガードスキルの挙動確認
4. **パフォーマンステスト**: 視覚的検出によるCPU負荷

## 8. 技術的考慮事項

### 8.1 パフォーマンス最適化
- 視覚的検出は必要最小限の頻度で実行
- 検出領域を最小化してCPU負荷を軽減
- キャッシュシステムの実装

### 8.2 エラーハンドリング
- 視覚的検出失敗時のフォールバック
- ゲームアップデートによる座標ずれの検出
- 自動キャリブレーション機能

### 8.3 互換性維持
- 既存のタイマーベースシステムとの共存
- 段階的な移行パス
- 設定による新旧システムの切り替え

## 9. 期待される効果

1. **精度向上**: 実際のゲーム状態に基づく正確な制御
2. **効率改善**: スキル属性に応じた最適化
3. **拡張性**: 新しいスキルタイプへの対応が容易
4. **ユーザビリティ**: より直感的な設定UI

## 10. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| ゲームアップデートによるUI変更 | 高 | 座標の外部設定化、自動検出機能 |
| 視覚的検出の誤認識 | 中 | 複数の検証ポイント、フォールバック |
| パフォーマンス低下 | 中 | 最適化、検出頻度の調整 |
| 既存機能との競合 | 低 | 段階的実装、十分なテスト |

---

最終更新日: 2025-06-29  
バージョン: 2.9.4計画案  
作成者: Claude AI Assistant