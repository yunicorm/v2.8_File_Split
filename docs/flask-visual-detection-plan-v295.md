# Path of Exile マクロ - フラスコ視覚検出システム実装計画 v2.9.5

## 概要

本ドキュメントは、Path of Exile自動化マクロのフラスコシステムに、デュアルオーバーレイと色検出を用いた高精度な視覚検出システムを実装する計画を記述したものです。

### 目的
- フラスコ本体とプログレスバーを分離して検出精度を向上
- 色ベース検出により高速かつ堅牢な状態判定を実現
- Wine of the Prophet、Tincture、バフアイコンの統合管理

## システム設計

### デュアルオーバーレイシステム

#### 各フラスコスロットの構成
1. **Flask Body Overlay（上部）**
   - 用途：フラスコ内の液体色と量を検出
   - 検出対象：チャージ量（0-100%）
   - 色判定：赤（Life）、青（Mana）、シアン（Utility）、紫（Unique）

2. **Progress Bar Overlay（下部）**
   - 用途：フラスコ効果時間の検出
   - 検出対象：クリーム色のプログレスバー
   - 状態判定：効果中/クールダウン/使用可能

### 状態判定マトリクス

| チャージ | プログレスバー | 状態 | アクション |
|---------|--------------|------|------------|
| あり | なし | 使用可能 | フラスコ使用 |
| あり | あり | 使用中 | 待機 |
| なし | なし | 空 | チャージ待ち |
| なし | あり | 回復中 | 待機 |

### Tincture特殊検出

#### 検出要素（シンプル化）
1. **装備スロット枠の色**
   - オレンジ色発光 = アクティブ状態
   - 通常色 = 非アクティブ状態

2. **プログレスバー検出**
   - プログレスバーあり = クールダウン中
   - プログレスバーなし = 使用可能またはアクティブ

#### 状態判定ロジック
| スロット枠 | プログレスバー | 状態 | アクション |
|-----------|--------------|------|------------|
| オレンジ色 | - | アクティブ | 待機（効果中） |
| 通常色 | あり | クールダウン | 待機 |
| 通常色 | なし | 使用可能 | Tincture使用 |

#### 実装の利点
- マナバーンスタック追跡が不要
- 2つの視覚要素のみで完結
- 処理が高速かつシンプル
- エラーが発生しにくい

### Claude Codeへの修正された指示例

```
Path of Exileマクロで、視覚検出システムを実装します。
docs/flask-visual-detection-plan-v295.mdを確認してください。

重要な実装順序：
1. Tincture（最も簡単）: スロット枠の色とプログレスバー
2. Wine of the Prophet（中程度）: 2段階検出が必要
3. 通常フラスコ（やや複雑）: 液体レベル検出

Wine of the Prophetの重要な注意：
- 緑枠は他のバフにも存在する可能性あり
- カード型デザインの確認が必須
- 2段階検出：緑枠→カードデザイン

実装詳細：
- 緑枠RGB: R(0-100), G(150-255), B(0-100)
- カード判定：縦長の縦横比、複雑な色パターン
- 誤検出防止が重要

Phase 1から開始してください。
```

## 実装フェーズ

### Phase 1: 基盤構築（1.5日）

#### 1.1 デュアルオーバーレイUI
- フラスコ本体用とプログレスバー用の2つのオーバーレイ
- F9キーでの座標設定拡張
- 保存/読み込み機能

#### 1.2 基本インフラ
- 設定管理の拡張
- デバッグ表示機能
- エラーハンドリング

### Phase 2: 色検出基盤（1日）

#### 2.1 基本色検出
- PixelGetColorの実装
- 色範囲判定関数
- 設定可能な閾値

#### 2.2 Tincture検出
- オレンジ枠検出
- プログレスバー検出
- 状態管理（READY/ACTIVE/COOLDOWN）

### Phase 3: Wine of the Prophet実装（0.5-1日）

#### 3.1 カードバフ検出実装（パターンマッチング版）
```ahk
; Features/BuffDetection.ahk（新規）
InitializeCardPatterns() {
    ; 40種類のカードパターンを登録
    ; 各カードの中央部分のパターンを保存
    global CARD_PATTERNS := Map()
    ; パターンは事前に収集が必要
}

DetectDivinationCard() {
    ; Step 1: 緑枠を持つバフを検出
    greenFramedBuffs := FindGreenFramedBuffs()
    
    ; Step 2: 各バフをカードパターンと照合
    for buff in greenFramedBuffs {
        for cardName, pattern in CARD_PATTERNS {
            if (MatchesPattern(buff, pattern)) {
                return {
                    found: true,
                    name: cardName,
                    x: buff.x,
                    y: buff.y
                }
            }
        }
    }
    return {found: false}
}
```

#### 3.2 実装の複雑さ
- 事前のパターン収集が必須
- オーラとの区別が必要
- 処理時間がやや増加

### Phase 4: 最適化とテスト（1日）

#### 4.1 パフォーマンス最適化
- 検出頻度の動的調整
- キャッシュシステム
- 変化検出による効率化

#### 4.2 設定GUI更新
- デュアルオーバーレイ設定
- 色閾値調整
- バフ優先度設定

## 技術仕様

### ファイル構造
```
PoE-Macro/
├── Features/
│   ├── VisualDetection.ahk（既存・拡張）
│   ├── ColorDetection.ahk（新規）
│   ├── FlaskStateManager.ahk（新規）
│   └── BuffDetection.ahk（新規）
├── docs/
│   └── flask-visual-detection-plan.md（本文書）
└── Config.ini（拡張）
```

### Config.ini 追加設定
```ini
[ColorDetection]
Enabled=true
ColorThreshold=40
SamplingPoints=5
UpdateInterval=50

[DualOverlay]
FlaskBodyHeight=80
ProgressBarHeight=20
Spacing=5

[TinctureDetection]
SlotBorderThreshold=30    ; オレンジ色検出の閾値
CheckInterval=100         ; 状態確認間隔(ms)
DebugOverlay=false       ; デバッグ用オーバーレイ表示

[BuffDetection]
BuffAreaX=640
BuffAreaY=50
BuffAreaWidth=500        ; 広めに設定（動的配置対応）
BuffAreaHeight=80
ScanInterval=100         ; スキャン間隔（ms）
BlackThreshold=30        ; 黒判定の閾値（RGB各値がこれ以下）

[WineOfProphet]
ImplementationMode=Full   ; Full実装が可能に
PatternCount=40          ; 40種類すべて準備完了
PatternFolder=./patterns/cards/ ; パターン保存場所
UseAllPatterns=true      ; すべてのパターンを使用
GreenFrameRMin=0         ; 緑枠の色範囲
GreenFrameRMax=100
GreenFrameGMin=150
GreenFrameGMax=255
GreenFrameBMin=0
GreenFrameBMax=100
DebugMode=false
StatisticsEnabled=true
OptimizeSearch=true      ; 高速検索を有効化
```

### 色定義
```ahk
; フラスコ液体色の定義
FLASK_COLORS := Map(
    "Life", {r: 200, g: 50, b: 50, threshold: 40},
    "Mana", {r: 50, g: 50, b: 200, threshold: 40},
    "Utility", {r: 50, g: 200, b: 200, threshold: 40},
    "Unique", {r: 150, g: 50, b: 200, threshold: 40}
)

; UI要素の色定義
PROGRESS_BAR_COLOR := {r: 255, g: 248, b: 220}     ; クリーム色
TINCTURE_ACTIVE_COLOR := {r: 255, g: 140, b: 0}    ; オレンジ色（枠の発光）
SLOT_BORDER_NORMAL := {r: 100, g: 100, b: 100}     ; 通常時の枠色

; Divination Cardバフの構造要素（参考）
CARD_STRUCTURE := {
    outer_border: {r: 139, g: 90, b: 43},          ; 茶色の外枠
    black_bg: {r_max: 30, g_max: 30, b_max: 30},  ; 黒い背景
    green_frame: {                                  ; 緑の装飾枠
        r_min: 0,   r_max: 100,
        g_min: 150, g_max: 255,
        b_min: 0,   b_max: 100
    }
    ; 内部デザインはパターンマッチングで判定
}
```

## 実装上の注意事項

### Tincture検出の簡略化メリット
1. **マナバーンスタック追跡が不要**
   - バフエリアの数値読み取り不要
   - OCR処理を回避
   - 処理速度の大幅向上

2. **2要素のみで完全な状態判定**
   - スロット枠の色（オレンジ/通常）
   - プログレスバーの有無
   - エラー率の低減

3. **実装の単純性**
   - 色検出関数2つのみ
   - 複雑な状態遷移管理が不要
   - デバッグが容易

### パフォーマンス
1. **色検出の高速性**
   - PixelGetColor: 5-10ms
   - 画像パターン: 50-100ms
   - 必要最小限の領域のみ検出

2. **更新頻度の最適化**
   - 通常時: 100ms間隔
   - 変化検出時: 50ms間隔
   - アイドル時: 200ms間隔

### エラーハンドリング
1. **フォールバック戦略**
   - 色検出失敗 → パターン認識
   - パターン認識失敗 → タイマーベース
   - 全失敗 → 手動制御

2. **自動補正**
   - 解像度変更検出
   - 座標ドリフト補正
   - 明るさ変化対応

### 互換性
1. **既存システムとの共存**
   - タイマーベースモード維持
   - ハイブリッドモード実装
   - 段階的移行サポート

2. **解像度対応**
   - 相対座標使用
   - スケーリング対応
   - プリセット提供

## テスト計画

### 単体テスト
- 各色検出関数の精度
- 緑枠検出の信頼性
- 状態判定の正確性
- エッジケースの処理

### Wine of the Prophet専用テスト
1. **パターンマッチングテスト**
   - 40種類すべての検出精度
   - オーラとの判別確認
   - 検出速度の測定

2. **実環境テスト**
   - 複数バフ混在時の動作
   - 動的配置への対応
   - エッジケースの処理

3. **パフォーマンステスト**
   - 40パターンの検索速度
   - CPU使用率の確認
   - 最適化の効果測定

### Tincture専用テスト
1. **状態遷移テスト**
   - READY → ACTIVE（オレンジ枠検出）
   - ACTIVE → COOLDOWN（オレンジ枠消失＋プログレスバー出現）
   - COOLDOWN → READY（プログレスバー消失）

2. **エッジケーステスト**
   - 画面の明るさ変化
   - スキルエフェクトの干渉
   - 解像度変更時の動作

### 統合テスト
- フラスコループの安定性
- Tincture/Wine連携
- バフ管理の動作

### ストレステスト
- 長時間実行の安定性
- CPU/メモリ使用率
- エラー回復能力

## 成功指標

1. **検出精度**: 95%以上
2. **応答速度**: 50ms以内
3. **CPU使用率**: 5%以下
4. **メモリ使用**: 50MB以下
5. **エラー率**: 0.1%以下

## リスク管理

### 技術的リスク（大幅に軽減）
- ゲームアップデートによる色/デザイン変更
- バフアイコンの動的配置（スキャンで対応）
- 解像度/設定の多様性
- パフォーマンス問題

### 対策
- 色範囲の柔軟な設定（Config.ini）
- 動的スキャンによる位置非依存
- パターンの定期的な確認
- 最適化による高速化
- フォールバック機能

### リスク軽減の成功要因
1. **データ収集完了**
   - 最大のリスクだったデータ収集が完了
   - 高品質なパターンで精度向上
   - 実装の見通しが明確

2. **技術的な明確性**
   - FindTextの実績ある手法
   - オーラとの判別方法確立
   - 実装パスが確定

## 実装の利点と注意点

### 2段階検出の利点

1. **高い精度**
   - 緑枠だけでは誤検出の可能性
   - カードデザイン確認で精度向上
   - 他のバフとの明確な区別

2. **実装の柔軟性**
   - 簡易モード：緑枠＋基本形状
   - 詳細モード：より厳密な判定
   - 段階的な精度向上が可能

3. **40種類の個別登録は依然不要**
   - カードの共通特徴で判定
   - 新しいカードにも対応可能
   - メンテナンスが容易

### 実装優先順位（最終版）

1. **Tincture検出**（最優先）
   - スロット枠とプログレスバーのみ
   - 最も簡単で確実

2. **Wine of the Prophet**（高優先）
   - 2段階検出で実装
   - やや複雑だが実現可能

3. **通常フラスコ**（中優先）
   - 液体レベルの検出
   - 実装難度は中程度

### 推定実装時間（パターン準備済み版）
- **Phase 1（基盤）**: 1.5日
- **Phase 2（色検出＋Tincture）**: 1日
- **Phase 3（Wine）**: 1-1.5日（パターン準備済み）
- **Phase 4（最適化）**: 1日
- **合計**: 4.5-5日（大幅短縮）

### 実装の難易度（最新版）
- **Tincture**: ⭐⭐☆☆☆（簡単）
- **Wine of the Prophet**: ⭐⭐⭐☆☆（中程度）
- **通常フラスコ**: ⭐⭐⭐☆☆（中程度）

### 成功要因
- 40種類のパターン収集完了
- 高品質なトリミング（緑枠＋1px）
- FindTextでの高精度検出が可能

## まとめ

本実装により、現在のタイマーベースシステムから、より正確で柔軟な視覚ベースシステムへの移行が実現します。

### 主な改善点
1. **デュアルオーバーレイ**: フラスコ本体とプログレスバーの独立検出
2. **色検出の採用**: 高速かつ堅牢な状態判定
3. **Tinctureの簡略化**: 2要素のみでの完全な状態管理
4. **Wine of the Prophet**: 黒背景＋緑枠による簡潔な実装

### 決定的な発見
1. **Divination Cardバフの構造**
   - 茶色外枠→黒背景→緑正方形枠→カードデザイン
   - 黒背景＋緑枠の組み合わせが特徴的
   - この2要素だけで確実に判定可能

2. **実装の劇的な簡略化**
   - 40種類の個別パターン不要
   - 複雑な形状認識不要
   - 色の組み合わせだけで判定

### 実装の容易さ（更新版）
- **最も簡単**: Tincture（1日）
- **簡単**: Wine of the Prophet（0.5-1日）
- **やや複雑**: 通常フラスコ（2日）
- **全体**: 4.5-6日で完成可能

## 実装成功への道筋

### 準備完了状態

1. **データ収集完了**
   - 40種類のカードパターン（✓）
   - 高品質トリミング（✓）
   - 実装準備万全（✓）

2. **技術的明確性**
   - FindTextによる実装方針確定
   - オーラとの判別方法確立
   - 各機能の実装手順明確

3. **リスク最小化**
   - 最大の障壁（データ収集）クリア
   - 段階的実装で確実に進行
   - フォールバック戦略あり

### 実装の確実性

| 機能 | データ準備 | 実装難易度 | 成功確率 |
|------|-----------|------------|----------|
| Tincture | 不要 | ⭐⭐☆☆☆ | 95%+ |
| Wine | 完了 | ⭐⭐⭐☆☆ | 95%+ |
| フラスコ | 不要 | ⭐⭐⭐☆☆ | 85%+ |

### 次のステップ
1. パターンファイルの整理・命名
2. FindTextパターン生成
3. Phase 1から順次実装
4. 各フェーズでテストと調整

### 予想される成果
- **完全自動化**：3つのシステムすべてVisual化
- **高精度**：誤検出・誤動作の最小化
- **保守性**：将来の更新にも対応可能