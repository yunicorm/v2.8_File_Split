# Path of Exile マクロ v2.8.2

## 概要

このマクロは、Path of Exileにおける特定のビルド（Wine of the Prophet使用）向けに最適化された自動化ツールです。マナ管理、スキル自動実行、フラスコ管理などを統合的に制御します。

**v2.8.2の主な改善点**：
- 外部設定ファイル（Config.ini）による簡単なカスタマイズ
- 包括的なエラーハンドリングによる安定性向上
- ホットキー競合の自動検出
- マナ検出の最適化によるパフォーマンス向上
- 自動ログローテーション機能

## 主要機能と動作原理

### 1. Wine of the Prophet システム

**概要**：Enkindling Orbによって強化されたMana Flaskの効果を最大限活用するシステム

**動作原理**：
- **Enkindling Orb効果**：効果時間中（6.05秒）チャージ獲得不可、77%効果増加
- **チャージ獲得式**：`1×(1.50+ManaB%)×1.77 チャージ/秒`
- **The Tides of Time**：フラスコチャージ獲得 +50%
- **Mana Burn**：最大340%の追加効果

**タイミング調整**（Config.iniで調整可能）：
```
経過時間     | Wine使用間隔
0-60秒      | 22-22.5秒
60-90秒     | 19.5-20秒
90-120秒    | 17.5-18秒
120-170秒   | 16-16.5秒
170秒以上   | 14.5-15秒
```

### 2. マナ監視システム（完全枯渇検出式）

**検出方式**：
- 円形マナオーブの下部3つの高さ（85%、90%、95%）で検出
- 各高さで5ポイント、合計15ポイントをチェック
- 全ポイントで青色が検出されない場合、完全枯渇（0/26）と判定
- **v2.8.2新機能**：最適化モードによる高速検出（中央1点チェック→必要時のみ詳細検出）

**座標設定**（Config.iniで調整可能）：
- マナオーブ中心：X=3294, Y=1300
- 半径：139ピクセル
- 青色閾値：40以上（青が赤・緑より20以上大きい）

**重要な設定**：
- ゲーム内で「Always Show Mana Cost」を**必ずOFF**にする
- リザーブされたマナを非表示にする

### 3. Tincture管理システム

**基本動作**：
1. マクロ開始時：即座にTincture（3キー）を使用
2. マナ完全枯渇検出時：Tinctureが切れたと判定
3. 5.41秒のクールダウン後、再使用を試行

**再試行メカニズム**：
- 最大5回まで自動再試行（Config.iniで調整可能）
- 使用後1秒待機してマナ状態を確認
- マナが30%以上または回復傾向なら成功と判定
- 失敗時は0.5秒後に再試行

### 4. フラスコ自動化

**マナフラスコ（2キー）**：
- 4.5-4.8秒間隔で継続的に使用
- Tincture再使用時にタイミングをリセット
- マクロ実行中は常に動作

### 5. スキル自動化

**実行されるスキル**（すべてConfig.iniで変更可能）：
- **E, R キー**：1-1.1秒間隔でランダムに実行
- **T キー**：4.1-4.2秒間隔で実行
- **4 キー**（Wine of the Prophet）：動的間隔（上記参照）

### 6. エリア検出システム（Client.txtログ監視）

**v2.9の新機能：より確実なエリア移動検出**

**検出方法**：
- Path of ExileのClient.txtログファイルを監視
- "You have entered [エリア名]" のログエントリーを検出
- ピクセル検出よりも確実で、ゲーム更新の影響を受けない

**動作フロー**：
1. ログファイルで新しいエリアへの移動を検出
2. マクロを自動的に一時停止
3. プレイヤーの入力（移動、スキル使用など）を待機
4. 入力検出後0.5秒でマクロ自動再開

**非戦闘エリアの自動識別**：
- ハイドアウト（Hideout）
- 町エリア（Encampment、Oriath等）
- Aspirants' Plaza（ラビリンス待機エリア）
- これらのエリアでは自動再開をスキップ

**設定**：
- `Config.ini`の`[ClientLog]`セクションで設定可能
- ログファイルパスのカスタマイズ可能
- 監視間隔の調整可能（デフォルト250ms）

## 想定される動作フロー

### マップ開始時
1. エリアに入る
2. プレイヤーが移動開始（任意のキー/クリック）
3. マクロが自動的に起動
4. Tincture使用 → マナフラスコ開始 → スキルループ開始

### 戦闘中
1. **通常時**：
   - E, R, Tを自動実行
   - マナフラスコを定期使用
   - Wine of the Prophetを適切な間隔で使用

2. **マナ枯渇時**：
   - Tinctureのバフが切れる
   - マナが0/26まで低下
   - 5.41秒後にTincture再使用
   - マナフラスコのタイミングリセット

### エリア移動時
1. ロード画面を自動検出
2. 全ての自動機能を一時停止
3. 新エリアでプレイヤーの行動を待つ
4. 行動検出後に自動再開

## ファイル構造

```
PoE-Macro/
├── Config.ini                  # 設定ファイル（初回実行時に自動生成）
├── Main.ahk                    # メインエントリーポイント
├── Config.ahk                  # 設定とグローバル変数
├── Core/                       # コア機能
│   ├── MacroController.ahk    # マクロの開始/停止制御
│   ├── TimerManager.ahk       # タイマー管理
│   └── WindowManager.ahk      # ウィンドウ検出と管理
├── Features/                   # 機能別モジュール
│   ├── ManaMonitor.ahk        # マナ監視システム
│   ├── TinctureManager.ahk    # Tincture管理
│   ├── FlaskManager.ahk       # フラスコ自動化
│   ├── SkillAutomation.ahk    # スキル自動化
│   └── LoadingScreen.ahk      # ロード画面検出
├── UI/                         # UI関連
│   ├── Overlay.ahk            # オーバーレイ表示
│   ├── StatusDisplay.ahk      # ステータス表示
│   └── DebugDisplay.ahk       # デバッグ表示
├── Utils/                      # ユーティリティ
│   ├── ConfigManager.ahk      # 設定ファイル管理
│   ├── HotkeyValidator.ahk    # ホットキー検証
│   ├── ColorDetection.ahk     # 色検出関数
│   ├── Coordinates.ahk        # 座標計算
│   └── Logger.ahk             # ログ機能
├── Hotkeys/                    # ホットキー定義
│   ├── MainHotkeys.ahk        # メインホットキー
│   └── DebugHotkeys.ahk       # デバッグ用ホットキー
└── logs/                       # ログファイル保存ディレクトリ（自動生成）
```

## 必要な環境

- **AutoHotkey**: v2.0以降
- **解像度**: 3440x1440（ウルトラワイド）推奨
- **対応ウィンドウ**: 
  - Path of Exile (PathOfExileSteam.exe)
  - Steam Remote Play (streaming_client.exe)

## インストールと使用方法

1. **AutoHotkey v2.0**以降をインストール
2. すべてのファイルを`PoE-Macro`フォルダに配置
3. `Main.ahk`を実行（初回実行時にConfig.iniが自動生成される）
4. Path of ExileまたはSteam Remote Playウィンドウをアクティブに
5. **F12**キーでマクロのオン/オフ

## ホットキー一覧

### メイン操作
| キー | 機能 |
|------|------|
| **F12** | マクロのオン/オフ切り替え |
| **Ctrl+F12** | 緊急停止（全機能を即座に停止） |
| **Shift+F12** | マクロ再起動 |
| **Alt+F12** | 設定リロード（Config.ini再読み込み）※v2.8.2新機能 |
| **Pause** | 一時停止/再開 |
| **ScrollLock** | ステータス表示の切り替え |
| **Ctrl+H** | 登録済みホットキー一覧表示 ※v2.8.2新機能 |

### デバッグ機能
| キー | 機能 |
|------|------|
| **F11** | マナ状態デバッグ表示 |
| **F10** | ロード画面検出のオン/オフ |
| **F9** | 待機モード切り替え（簡易/詳細） |
| **F8** | アクティブタイマー表示 |
| **F7** | 全体デバッグ情報表示 |
| **F6** | ログビューアを開く |

### 開発用
| キー | 機能 |
|------|------|
| **Ctrl+D** | デバッグモード切り替え |
| **Ctrl+L** | ログ記録切り替え |
| **Ctrl+S** | マウス座標と色情報表示 |
| **Ctrl+M** | マナ状態手動チェック |
| **Ctrl+T** | テストオーバーレイ表示 |
| **Ctrl+R** | マクロ状態リセット |
| **Ctrl+P** | パフォーマンステスト |

## 設定のカスタマイズ（v2.8.2新機能）

設定は`Config.ini`ファイルで管理されます。初回実行時に自動生成され、メモ帳などで編集できます。

### 主な設定項目

#### [General] - 一般設定
```ini
DebugMode=false         # デバッグモード
LogEnabled=true         # ログ記録
MaxLogSize=10          # ログファイル最大サイズ (MB)
LogRetentionDays=7     # ログ保持日数
```

#### [Keys] - キー設定
```ini
Tincture=3            # Tinctureキー
ManaFlask=2           # マナフラスコキー
SkillE=E              # スキルEキー
SkillR=R              # スキルRキー
SkillT=T              # スキルTキー
WineProphet=4         # Wine of the Prophetキー
```

#### [Timing] - タイミング設定（ミリ秒）
```ini
SkillER_Min=1000      # E,Rキーの最小間隔
SkillER_Max=1100      # E,Rキーの最大間隔
SkillT_Min=4100       # Tキーの最小間隔
SkillT_Max=4200       # Tキーの最大間隔
Flask_Min=4500        # フラスコの最小間隔
Flask_Max=4800        # フラスコの最大間隔
```

#### [Mana] - マナ検出設定
```ini
CenterX=3294          # マナオーブ中心X座標
CenterY=1300          # マナオーブ中心Y座標
Radius=139            # マナオーブ半径
BlueThreshold=40      # 青色検出閾値
OptimizedDetection=true  # 最適化モード（高速検出）
```

### 設定の適用方法
1. `Config.ini`をテキストエディタで編集
2. 保存後、ゲーム内で`Alt+F12`を押して設定をリロード
3. マクロの再起動は不要

## 重要な注意事項

### ゲーム内設定
1. **Always Show Mana Cost**を必ず**OFF**にする
2. リザーブされたマナの表示を**OFF**にする
3. UI設定は変更しない（マナオーブの位置が変わるため）

### 解像度について
- デフォルトは**3440x1440**解像度用に最適化
- 他の解像度では`Config.ini`の`[Resolution]`セクションで設定
- 座標は自動的にスケーリングされます

### パフォーマンスへの影響
- マナ監視：100ms間隔（最適化モードで高速化）
- ロード画面検出：250ms間隔
- 色検出タイムアウト：50ms（Config.iniで調整可能）

## トラブルシューティング

### マクロが動作しない
1. AutoHotkey v2.0以降がインストールされているか確認
2. ゲームウィンドウがアクティブか確認
3. `F6`でログを確認
4. `Ctrl+H`でホットキー競合がないか確認
5. 管理者権限で実行してみる

### マナ検出が正しくない
1. ゲーム内設定を確認（上記参照）
2. `F11`でマナデバッグ表示を確認
3. `Config.ini`の`[Mana]`セクションで座標を調整
4. `OptimizedDetection=false`で詳細検出モードを試す

### Tinctureが再使用されない
1. マナが完全に枯渇（0/26）しているか確認
2. `F7`でTincture状態を確認
3. `Config.ini`で`RetryMax`を増やす

### ロード画面検出が機能しない
1. `F10`で機能が有効か確認
2. `Config.ini`で`[LoadingScreen]`の設定を確認
3. フルスクリーンモードで実行しているか確認

### 設定が反映されない
1. `Config.ini`を保存したか確認
2. `Alt+F12`で設定をリロード
3. 値の形式が正しいか確認（数値、true/false）

### ログファイルが大きくなりすぎる
1. `Config.ini`で`MaxLogSize`を調整（デフォルト10MB）
2. `LogRetentionDays`で古いログの自動削除期間を設定
3. `LogEnabled=false`でログを無効化

## 既知の制限事項

1. **解像度依存**：デフォルトは3440x1440、他の解像度はConfig.iniで調整
2. **言語依存**：英語版でのみテスト済み
3. **UIスケール**：100%以外のUIスケールには非対応
4. **ウィンドウモード**：フルスクリーンまたはウィンドウフルスクリーン推奨

## 開発者向け情報

### 新機能の追加方法
1. `Features/`ディレクトリに新しいファイルを作成
2. `Main.ahk`でインクルード（依存関係に注意）
3. 必要な設定を`Config.ini`に追加
4. `ConfigManager.Get()`で設定値を取得
5. ホットキーが必要な場合は`HotkeyValidator.Register()`で登録

### デバッグ方法
1. `Config.ini`で`DebugMode=true`に設定
2. `Ctrl+L`でログ記録を有効化
3. `logs/`ディレクトリのログファイルを確認
4. `F8`でタイマー状態を確認
5. `F7`で全体の状態を確認
6. `Ctrl+P`でパフォーマンステストを実行

### コード規約
- 関数名：PascalCase（例：`CheckManaRadial`）
- 変数名：snake_case with g_prefix（例：`g_macro_active`）
- 定数：UPPER_CASE（例：`TIMING_MANA_DEPLETED_CD`）
- コメント：日本語可
- エラーハンドリング：すべての主要関数でtry-catchを使用

## 更新履歴

### v2.8.2（2024年最新）
- **外部設定ファイル対応**：Config.iniによる簡単な設定管理
- **エラーハンドリング強化**：全主要関数でtry-catch実装
- **ホットキー検証システム**：起動時の競合自動検出
- **マナ検出最適化**：高速モードでパフォーマンス向上
- **ログローテーション**：自動的なログファイル管理
- **設定リロード機能**：Alt+F12で即座に反映
- **座標自動スケーリング**：異なる解像度への対応改善

### v2.8.1
- Tincture連打バグ修正
- マクロOFF時の再試行継続問題を修正

### v2.8
- Tincture再試行メカニズム実装
- マナ状態によるTincture効果確認機能

### v2.7.3
- 初回起動時のマナ誤検出修正
- マナモニタリング開始遅延実装

### v2.7.2
- ステータスオーバーレイサイズ修正
- テキスト表示の見切れ防止

### v2.7.1
- F12キー連打防止強化
- キーリリース検出改善

### v2.7
- Mana Burnスタック管理を削除
- Tincture + マナフラスコの新フロー実装
- 5キーループを削除

## ライセンス

個人使用のみ。再配布禁止。

## サポート

問題が発生した場合：
1. まずこのREADMEのトラブルシューティングを確認
2. `F6`でログを確認
3. `Config.ini`の設定を確認
4. デバッグ機能を使用して詳細を調査
5. 必要に応じて設定を調整

## 貢献者への感謝

このマクロの開発にあたり、Path of Exileコミュニティの皆様からの貴重なフィードバックとテストに感謝いたします。